# Personal Flake Toolkit #

This repository contains my personal flake and supporting tooling for reproducible development environments, NixOS configuration, and safe system switching. The core concept is the studio: an isolated, self-contained workspace with its own scripts, git repo, and development utilities.

Studios allow me to experiment freely — even with code that affects the switch process itself — without risking a broken system. Every studio is a temporary or permanent sandbox that can be snapshotted, hydrated, rebased, and safely deployed.

## Studio Overview ##

A studio is a lightweight git repository generated by the studio command. It contains:

A full checkout of the personal flake’s code

A set of git aliases for state-management workflows:

git mutable-snapshot

git mutable-scratch

git mutable-rebase

Scripts and utilities for testing, building, and switching safely

## Launching a Studio ##

studio (no args):
Creates a reusable, named studio and opens it in an IDE.

studio <args>:
Creates a fresh, studio.
Typically used as:

studio $(uuidgen)

(effectively ephemeral)


Every studio you create is a full, isolated environment that never interferes with other studios or your live system until you explicitly switch.

## Safe Workflow (in general) ##

1. Start from your Current Studio.
2. Execute `cd $( git mutable snapshot )`.  This creates an immutable snapshot of the current studio.
3. Execute `git flake-switch`.  This runs checks.  It stops if any of the checks fail.  It switches to the environmet specified by the studio.  The switch is robust to reboot.

## Safe Workflow for Modifying Switch Logic ##

Changing anything that affects how git flake switch or your system deployment works must be done carefully.
If you change the "switch" script or anything it depends on then this is a safe workflow to follow.
Studios let you do this safely.

Below is the recommended workflow.

1. Start From Your Current Studio.
2. Let `BRANCH=$( git rev-parse HEAD )`.  Record your current branch.
3. cd "$(git mutable-snapshot)".  This creates an immutable snapshot of the current branch.
4. Execute `nix flake test`.  This deploys the current branch.  But it will not survive reboot.  So if you don't like it, then a reboot will fix it.  (There are other ways, but this is perhaps the easiest.)
5. `cd $(studio $(uuidgen))`.  This changes the studio to a new one using updated scripts.  The uuidgen makes it effectively ephemeral.
6. execute `git mutable-hydrate $BRANCH`.  This revises the code to that from your original studio.
7. Testing (optional but recommended)
   1. `git flake-check`
   2. `git flake-build-vm`
   3. `git flake-test`
8. `git flake-switch` The switch is now robust to reboot.